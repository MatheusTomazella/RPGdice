/**
 * @dice-roller/rpg-dice-roller - An advanced JS based dice roller that can roll various types of dice and modifiers, along with mathematical equations.
 * 
 * @version 5.1.0
 * @license MIT
 * @author GreenImp Media <info@greenimp.co.uk> (http://greenimp.co.uk)
 * @link https://dice-roller.github.io/documentation
 */

import{evaluate as t}from"mathjs";class CompareOperatorError extends TypeError{constructor(t){super(`Operator "${t}" is invalid`),TypeError.captureStackTrace&&TypeError.captureStackTrace(this,CompareOperatorError),this.name="CompareOperatorError",this.operator=t}}class DataFormatError extends Error{constructor(t){super(`Invalid data format: ${t}`),Error.captureStackTrace&&Error.captureStackTrace(this,DataFormatError),this.name="ImportError",this.data=t}}class DieActionValueError extends Error{constructor(t,e=null){super(`Die "${t}" must have more than 1 possible value to ${e||"do this action"}`),Error.captureStackTrace&&Error.captureStackTrace(this,DieActionValueError),this.name="DieActionValueError",this.action=e,this.die=t}}class NotationError extends Error{constructor(t){super(`Notation "${t}" is invalid`),Error.captureStackTrace&&Error.captureStackTrace(this,NotationError),this.name="NotationError",this.notation=t}}class RequiredArgumentError extends Error{constructor(t=null){super("Missing argument"+(t?` "${t}"`:"")),Error.captureStackTrace&&Error.captureStackTrace(this,RequiredArgumentError),this.argumentName=t}}var e=Object.freeze({__proto__:null,CompareOperatorError:CompareOperatorError,DataFormatError:DataFormatError,DieActionValueError:DieActionValueError,NotationError:NotationError,RequiredArgumentError:RequiredArgumentError});const r=e=>t(e),n=t=>("number"==typeof t||"string"==typeof t)&&(!Number.isNaN(t)&&Number.isFinite(Number(t))),i=t=>{if(!n(t))return!1;const e=Number(t);return e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER};function o(t){return 0|t.next()}function s(t,e){return 0===e?t:r=>t(r)+e}function a(t){const e=0|t.next();return 4294967296*(2097151&e)+(t.next()>>>0)+(2097152&e?-9007199254740992:0)}function u(t){for(;;){const e=0|t.next();if(!(4194304&e)){return 4294967296*(2097151&e)+(t.next()>>>0)+(2097152&e?-9007199254740992:0)}if(4194304==(8388607&e)&&0==(0|t.next()))return 9007199254740992}}function l(t){return t.next()>>>0}function c(t){return 4294967296*(2097151&t.next())+(t.next()>>>0)}function h(t){for(;;){const e=0|t.next();if(!(2097152&e)){return 4294967296*(2097151&e)+(t.next()>>>0)}if(0==(2097151&e)&&0==(0|t.next()))return 9007199254740992}}function f(t){return 0==(t+1&t)}function p(t){return f(t)?(e=t,t=>t.next()&e):function(t){const e=t+1,r=e*Math.floor(4294967296/e);return t=>{let n=0;do{n=t.next()>>>0}while(n>=r);return n%e}}(t);var e}function d(t){const e=t+1;if(0==(0|e)){const t=(e/4294967296|0)-1;if(f(t))return r=t,t=>4294967296*(t.next()&r)+(t.next()>>>0)}var r;return function(t){const e=t*Math.floor(9007199254740992/t);return r=>{let n=0;do{n=4294967296*(2097151&r.next())+(r.next()>>>0)}while(n>=e);return n%t}}(e)}function m(t,e){return r=>{let n=0;do{const t=0|r.next();n=4294967296*(2097151&t)+(r.next()>>>0)+(2097152&t?-9007199254740992:0)}while(n<t||n>e);return n}}function g(t,e){if(t=Math.floor(t),e=Math.floor(e),t<-9007199254740992||!isFinite(t))throw new RangeError("Expected min to be at least -9007199254740992");if(e>9007199254740992||!isFinite(e))throw new RangeError("Expected max to be at most 9007199254740992");const r=e-t;return r<=0||!isFinite(r)?()=>t:4294967295===r?0===t?l:s(o,t+2147483648):r<4294967295?s(p(r),t):9007199254740991===r?s(c,t):r<9007199254740991?s(d(r),t):e-1-t==9007199254740991?s(h,t):-9007199254740992===t&&9007199254740992===e?u:-9007199254740992===t&&9007199254740991===e?a:-9007199254740991===t&&9007199254740992===e?s(a,1):9007199254740992===e?s(m(t-1,e-1),1):m(t,e)}function y(t){return 1==(1&t.next())}function w(t,e){return r=>t(r)<e}function b(t,e){return null==e?null==t?y:function(t){if(t<=0)return()=>!1;if(t>=1)return()=>!0;{const e=4294967296*t;return e%1==0?w(o,e-2147483648|0):w(c,Math.round(9007199254740992*t))}}(t):t<=0?()=>!1:t>=e?()=>!0:w(g(0,e-1),t)}function x(t){return g(1,t)}function v(t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_-"){const e=t.length;if(!e)throw new Error("Expected pool not to be an empty string");const r=g(0,e-1);return(e,n)=>{let i="";for(let o=0;o<n;++o){const n=r(e);i+=t.charAt(n)}return i}}const E=v("0123456789abcdef"),R=v("0123456789abcdef".toUpperCase());function S(t,e){return t<0?Math.max(t+e,0):Math.min(t,e)}function A(t){const e=+t;return e<0?Math.ceil(e):Math.floor(e)}function M(t){return c(t)/9007199254740992}function C(t){return h(t)/9007199254740992}const T=Array.prototype.slice;function O(t,e,r=0){const n=e.length;if(n)for(let i=n-1>>>0;i>r;--i){const r=g(0,i)(t);if(i!==r){const t=e[i];e[i]=e[r],e[r]=t}}return e}const N=(()=>{try{if("xxx"==="x".repeat(3))return(t,e)=>t.repeat(e)}catch(t){}return(t,e)=>{let r="";for(;e>0;)1&e&&(r+=t),e>>=1,t+=t;return r}})();function $(t,e){return N("0",e-t.length)+t}const F={next:()=>4294967296*Math.random()|0};class Random{constructor(t=F){this.engine=t}int32(){return o(this.engine)}uint32(){return l(this.engine)}uint53(){return c(this.engine)}uint53Full(){return h(this.engine)}int53(){return a(this.engine)}int53Full(){return u(this.engine)}integer(t,e){return g(t,e)(this.engine)}realZeroToOneInclusive(){return C(this.engine)}realZeroToOneExclusive(){return M(this.engine)}real(t,e,r=!1){return function(t,e,r=!1){if(!isFinite(t))throw new RangeError("Expected min to be a finite number");if(!isFinite(e))throw new RangeError("Expected max to be a finite number");return s((n=r?C:M,1==(i=e-t)?n:0===i?()=>0:t=>n(t)*i),t);var n,i}(t,e,r)(this.engine)}bool(t,e){return b(t,e)(this.engine)}pick(t,e,r){return function(t,e,r,n){const i=e.length;if(0===i)throw new RangeError("Cannot pick from an empty array");const o=null==r?0:S(A(r),i),s=void 0===n?i:S(A(n),i);if(o>=s)throw new RangeError(`Cannot pick between bounds ${o} and ${s}`);return e[g(o,s-1)(t)]}(this.engine,t,e,r)}shuffle(t){return O(this.engine,t)}sample(t,e){return function(t,e,r){if(r<0||r>e.length||!isFinite(r))throw new RangeError("Expected sampleSize to be within 0 and the length of the population");if(0===r)return[];const n=T.call(e),i=n.length;if(i===r)return O(t,n,0);const o=i-r;return O(t,n,o-1).slice(o)}(this.engine,t,e)}die(t){return x(t)(this.engine)}dice(t,e){return function(t,e){const r=x(t);return t=>{const n=[];for(let i=0;i<e;++i)n.push(r(t));return n}}(t,e)(this.engine)}uuid4(){return function(t){const e=t.next()>>>0,r=0|t.next(),n=0|t.next(),i=t.next()>>>0;return $(e.toString(16),8)+"-"+$((65535&r).toString(16),4)+"-"+$((r>>4&4095|16384).toString(16),4)+"-"+$((16383&n|32768).toString(16),4)+"-"+$((n>>4&65535).toString(16),4)+$(i.toString(16),8)}(this.engine)}string(t,e){return v(e)(this.engine,t)}hex(t,e){return function(t){return t?R:E}(e)(this.engine,t)}date(t,e){return function(t,e){const r=g(+t,+e);return t=>new Date(r(t))}(t,e)(this.engine)}}const P=(()=>{try{const t=new ArrayBuffer(4),e=new Int32Array(t);if(e[0]=2147483648,-2147483648===e[0])return Int32Array}catch(t){}return Array})();let D=null;let J=128;const q={next:()=>(J>=128&&(null===D&&(D=new P(128)),crypto.getRandomValues(D),J=0),0|D[J++])};const j=(()=>{try{if(-5===Math.imul(4294967295,5))return Math.imul}catch(t){}const t=65535;return(e,r)=>{const n=e&t,i=r&t;return n*i+((e>>>16&t)*i+n*(r>>>16&t)<<16>>>0)|0}})(),I=2567483615;class MersenneTwister19937{constructor(){this.data=new P(624),this.index=0,this.uses=0}static seed(t){return(new MersenneTwister19937).seed(t)}static seedWithArray(t){return(new MersenneTwister19937).seedWithArray(t)}static autoSeed(){return MersenneTwister19937.seedWithArray(function(t=F,e=16){const r=[];r.push(0|(new Date).getTime());for(let n=1;n<e;++n)r[n]=0|t.next();return r}())}next(){(0|this.index)>=624&&(G(this.data),this.index=0);const t=this.data[this.index];return this.index=this.index+1|0,this.uses+=1,0|function(t){return t^=t>>>11,t^=t<<7&2636928640,(t^=t<<15&4022730752)^t>>>18}(t)}getUseCount(){return this.uses}discard(t){if(t<=0)return this;for(this.uses+=t,(0|this.index)>=624&&(G(this.data),this.index=0);t+this.index>624;)t-=624-this.index,G(this.data),this.index=0;return this.index=this.index+t|0,this}seed(t){let e=0;this.data[0]=e=0|t;for(let t=1;t<624;t=t+1|0)this.data[t]=e=j(e^e>>>30,1812433253)+t|0;return this.index=624,this.uses=0,this}seedWithArray(t){return this.seed(19650218),function(t,e){let r=1,n=0;const i=e.length;let o=0|Math.max(i,624),s=0|t[0];for(;(0|o)>0;--o)t[r]=s=(t[r]^j(s^s>>>30,1664525))+(0|e[n])+(0|n)|0,r=r+1|0,++n,(0|r)>623&&(t[0]=t[623],r=1),n>=i&&(n=0);for(o=623;(0|o)>0;--o)t[r]=s=(t[r]^j(s^s>>>30,1566083941))-r|0,r=r+1|0,(0|r)>623&&(t[0]=t[623],r=1);t[0]=2147483648}(this.data,t),this}}function G(t){let e=0,r=0;for(;(0|e)<227;e=e+1|0)r=2147483648&t[e]|2147483647&t[e+1|0],t[e]=t[e+397|0]^r>>>1^(1&r?I:0);for(;(0|e)<623;e=e+1|0)r=2147483648&t[e]|2147483647&t[e+1|0],t[e]=t[e-227|0]^r>>>1^(1&r?I:0);r=2147483648&t[623]|2147483647&t[0],t[623]=t[396]^r>>>1^(1&r?I:0)}let V=null;let k=128;const _={next:()=>(k>=128&&(V=new Int32Array(new Int8Array(require("crypto").randomBytes(512)).buffer),k=0),0|V[k++])},B=Symbol("engine"),z=Symbol("random"),K={browserCrypto:q,nodeCrypto:_,MersenneTwister19937:MersenneTwister19937,nativeMath:F,min:{next:()=>0},max:{range:[],next(){return this.range[1]-this.range[0]}}};const W=new class NumberGenerator{constructor(t=F){this.engine=t||F}get engine(){return this[B]}set engine(t){if(t&&"function"!=typeof t.next)throw new TypeError("engine must have function `next()`");this[B]=t||F,this[z]=new Random(this[B])}integer(t,e){return this[B].range=[t,e],this[z].integer(t,e)}real(t,e,r=!1){return this[B].range=[t,e],this[z].real(t,e,r)}};var U=Object.freeze({__proto__:null,engines:K,generator:W});const Z=Symbol("operator"),L=Symbol("value");class ComparePoint{constructor(t,e){if(!t)throw new RequiredArgumentError("operator");if(!e&&0!==e)throw new RequiredArgumentError("value");this.operator=t,this.value=e}static isValidOperator(t){return"string"==typeof t&&/^(?:[<>!]?=|[<>]|<>)$/.test(t)}set operator(t){if(!this.constructor.isValidOperator(t))throw new CompareOperatorError(t);this[Z]=t}get operator(){return this[Z]}set value(t){if(!n(t))throw new TypeError("value must be a finite number");this[L]=Number(t)}get value(){return this[L]}isMatch(t){return((t,e,r)=>{const n=Number(t),i=Number(e);let o;if(Number.isNaN(n)||Number.isNaN(i))return!1;switch(r){case"=":case"==":o=n===i;break;case"<":o=n<i;break;case">":o=n>i;break;case"<=":o=n<=i;break;case">=":o=n>=i;break;case"!":case"!=":case"<>":o=n!==i;break;default:o=!1}return o})(t,this.value,this.operator)}toJSON(){const{operator:t,value:e}=this;return{operator:t,type:"compare-point",value:e}}toString(){return`${this.operator}${this.value}`}}class Modifier{constructor(){this.order=999}get name(){return"modifier"}get notation(){return""}get maxIterations(){return 1e3}run(t,e){return t}toJSON(){const{notation:t,name:e}=this;return{name:e,notation:t,type:"modifier"}}toString(){return this.notation}}const X=Symbol("compare-point");class ComparisonModifier extends Modifier{constructor(t){super(),t&&(this.comparePoint=t)}get comparePoint(){return this[X]}set comparePoint(t){if(!(t instanceof ComparePoint))throw new TypeError("comparePoint must be instance of ComparePoint");this[X]=t}get name(){return"comparison"}get notation(){return`${this.comparePoint||""}`}isComparePoint(t){return!!this.comparePoint&&this.comparePoint.isMatch(t)}toJSON(){const{comparePoint:t}=this;return Object.assign(super.toJSON(),{comparePoint:t})}}const H=Symbol("compound"),Q=Symbol("penetrate");class ExplodeModifier extends ComparisonModifier{constructor(t=null,e=!1,r=!1){super(t),this[H]=!!e,this[Q]=!!r,this.order=3}get compound(){return this[H]}get name(){return"explode"}get notation(){return`!${this.compound?"!":""}${this.penetrate?"p":""}${super.notation}`}get penetrate(){return this[Q]}run(t,e){if(e.min===e.max)throw new DieActionValueError(e,"explode");const r=t;return r.rolls=t.rolls.map((t=>{const r=[t];let i=t.value;for(let t=0;t<this.maxIterations&&this.isComparePoint(i);t++){const t=r[r.length-1],n=e.rollOnce();i=n.value,t.modifiers.add("explode"),this.penetrate&&(t.modifiers.add("penetrate"),n.value-=1),r.push(n)}return this.compound&&r.length>1?(t.value=(o=r.map((t=>t.value)),Array.isArray(o)?o.reduce(((t,e)=>t+(n(e)?parseFloat(`${e}`):0)),0):0),t.modifiers=["explode","compound"],this.penetrate&&t.modifiers.add("penetrate"),t):r;var o})).flat(),r}toJSON(){const{compound:t,penetrate:e}=this;return Object.assign(super.toJSON(),{compound:t,penetrate:e})}}const Y={compound:"!",explode:"!","critical-failure":"__","critical-success":"**",drop:"d",max:"v",min:"^",penetrate:"p","re-roll":"r","re-roll-once":"ro","target-failure":"_","target-success":"*"},tt=(...t)=>[...t].reduce(((t,e)=>{let r;return r=e instanceof Modifier?e.name:e,t+(Y[r]||r)}),""),et=Symbol("calculation-value"),rt=Symbol("modifiers"),nt=Symbol("initial-value"),it=Symbol("use-in-total"),ot=Symbol("value");class RollResult{constructor(t,e=[],r=!0){if(n(t))this[nt]=Number(t),this.modifiers=e||[],this.useInTotal=r;else{if(!t||"object"!=typeof t||Array.isArray(t))throw t===1/0?new RangeError("Result value must be a finite number"):new TypeError(`Result value is invalid: ${t}`);{const i=n(t.initialValue)?t.initialValue:t.value;if(!n(i))throw new TypeError(`Result value is invalid: ${i}`);this[nt]=Number(i),n(t.value)&&Number(t.value)!==this[nt]&&(this.value=t.value),n(t.calculationValue)&&parseFloat(`${t.calculationValue}`)!==this.value&&(this.calculationValue=t.calculationValue),this.modifiers=t.modifiers||e||[],this.useInTotal="boolean"==typeof t.useInTotal?t.useInTotal:r||!1}}}get calculationValue(){return n(this[et])?parseFloat(this[et]):this.value}set calculationValue(t){const e=n(t);if(t===1/0)throw new RangeError("Result calculation value must be a finite number");if(t&&!e)throw new TypeError(`Result calculation value is invalid: ${t}`);this[et]=e?parseFloat(`${t}`):null}get initialValue(){return this[nt]}get modifierFlags(){return tt(...this.modifiers)}get modifiers(){return this[rt]}set modifiers(t){if((Array.isArray(t)||t instanceof Set)&&[...t].every((t=>"string"==typeof t)))this[rt]=new Set([...t]);else{if(t||0===t)throw new TypeError(`modifiers must be a Set or array of modifier names: ${t}`);this[rt]=new Set}}get useInTotal(){return!!this[it]}set useInTotal(t){this[it]=!!t}get value(){return n(this[ot])?this[ot]:this[nt]}set value(t){if(t===1/0)throw new RangeError("Result value must be a finite number");if(!n(t))throw new TypeError(`Result value is invalid: ${t}`);this[ot]=Number(t)}toJSON(){const{calculationValue:t,initialValue:e,modifierFlags:r,modifiers:n,useInTotal:i,value:o}=this;return{calculationValue:t,initialValue:e,modifierFlags:r,modifiers:[...n],type:"result",useInTotal:i,value:o}}toString(){return this.value+this.modifierFlags}}const st=Symbol("rolls");class RollResults{constructor(t=[]){this.rolls=t}get length(){return this.rolls.length||0}get rolls(){return[...this[st]]}set rolls(t){if(!t||!Array.isArray(t))throw new TypeError(`rolls must be an array: ${t}`);this[st]=[],t.forEach((t=>{this.addRoll(t)}))}get value(){return this.rolls.reduce(((t,e)=>t+(e.useInTotal?e.calculationValue:0)),0)}addRoll(t){const e=t instanceof RollResult?t:new RollResult(t);this[st].push(e)}toJSON(){const{rolls:t,value:e}=this;return{rolls:t,type:"roll-results",value:e}}toString(){return`[${this.rolls.join(", ")}]`}}const at=Symbol("once");class ReRollModifier extends ComparisonModifier{constructor(t=!1,e=null){super(e),this.once=!!t,this.order=4}get name(){return"re-roll"}get notation(){return`r${this.once?"o":""}${super.notation}`}get once(){return!!this[at]}set once(t){this[at]=!!t}run(t,e){if(e.min===e.max)throw new DieActionValueError(e,"re-roll");return t.rolls.map((t=>{for(let r=0;r<this.maxIterations&&this.isComparePoint(t.value);r++){const r=e.rollOnce();if(t.value=r.value,t.modifiers.add("re-roll"+(this.once?"-once":"")),this.once)break}return t})),t}toJSON(){const{once:t}=this;return Object.assign(super.toJSON(),{once:t})}}const ut=Symbol("modifiers"),lt=Symbol("qty"),ct=Symbol("sides"),ht=Symbol("min-value"),ft=Symbol("max-value");class StandardDice{constructor(t,e=1,r=null,o=1,s=null){if(!t&&0!==t)throw new RequiredArgumentError("sides");if(t===1/0)throw new RangeError("numerical sides must be finite number");if(n(t)){if(t<1||!i(t))throw new RangeError("numerical sides must be a positive finite number")}else if("string"!=typeof t)throw new TypeError("non-numerical sides must be a string");if(!n(e))throw new TypeError("qty must be a positive finite integer");if(e<1||e>999)throw new RangeError("qty must be between 1 and 999");if(!n(o))throw new TypeError("min must a finite number");if(!i(o))throw new RangeError("min must a finite number");if(s&&!n(s))throw new TypeError("max must a finite number");if(s&&!i(s))throw new RangeError("max must a finite number");this[lt]=parseInt(`${e}`,10),this[ct]=t,r&&(this.modifiers=r),this[ht]=parseInt(o,10),this[ft]=s?parseInt(`${s}`,10):t}get average(){return(this.min+this.max)/2}get modifiers(){return this[ut]?new Map([...this[ut]].sort(((t,e)=>t[1].order-e[1].order))):null}set modifiers(t){let e;if(t instanceof Map)e=t;else if(Array.isArray(t))e=new Map(t.map((t=>[t.name,t])));else{if("object"!=typeof t)throw new TypeError("modifiers should be a Map, array, or an Object containing Modifiers");e=new Map(Object.entries(t))}if(e.size&&[...e.entries()].some((t=>!(t[1]instanceof Modifier))))throw new TypeError("modifiers must only contain Modifier instances");this[ut]=e,this[ut].forEach((t=>{t instanceof ExplodeModifier&&!t.comparePoint?t.comparePoint=new ComparePoint("=",this.max):t instanceof ReRollModifier&&!t.comparePoint&&(t.comparePoint=new ComparePoint("=",this.min))}))}get max(){return this[ft]}get min(){return this[ht]}get name(){return"standard"}get notation(){let t=`${this.qty}d${this.sides}`;return this.modifiers&&this.modifiers.size&&(t+=[...this.modifiers.values()].reduce(((t,e)=>t+e.notation),"")),t}get qty(){return this[lt]}get sides(){return this[ct]}roll(){const t=new RollResults;for(let e=0;e<this.qty;e++)t.addRoll(this.rollOnce());return(this.modifiers||[]).forEach((e=>{e.run(t,this)})),t}rollOnce(){return new RollResult(W.integer(this.min,this.max))}toJSON(){const{average:t,max:e,min:r,modifiers:n,name:i,notation:o,qty:s,sides:a}=this;return{average:t,max:e,min:r,modifiers:n,name:i,notation:o,qty:s,sides:a,type:"die"}}toString(){return this.notation}}class FudgeDice extends StandardDice{constructor(t=2,e=1,r=null){let n=t;if(n||0===n){if(1!==n&&2!==n)throw new RangeError("nonBlanks must be 1 or 2")}else n=2;super(n,e,r,-1,1)}get name(){return"fudge"}get nonBlanks(){return super.sides}get sides(){return`F.${this.nonBlanks}`}rollOnce(){let t=0;if(2===this.nonBlanks)t=W.integer(1,3)-2;else if(1===this.nonBlanks){const e=W.integer(1,6);1===e?t=-1:6===e&&(t=1)}return new RollResult(t)}}class PercentileDice extends StandardDice{constructor(t=1,e=null,r=!1){super(100,t,e),this.sidesAsNumber=!!r}get name(){return"percentile"}get sides(){return this.sidesAsNumber?super.sides:"%"}}var pt=Object.freeze({__proto__:null,FudgeDice:FudgeDice,PercentileDice:PercentileDice,StandardDice:StandardDice});class CriticalFailureModifier extends ComparisonModifier{constructor(t){super(t),this.order=9}get name(){return"critical-failure"}get notation(){return`cf${super.notation}`}run(t,e){return t.rolls.forEach((t=>(this.isComparePoint(t.value)&&t.modifiers.add("critical-failure"),t))),t}}class CriticalSuccessModifier extends ComparisonModifier{constructor(t){super(t),this.order=8}get name(){return"critical-success"}get notation(){return`cs${super.notation}`}run(t,e){return t.rolls.forEach((t=>(this.isComparePoint(t.value)&&t.modifiers.add("critical-success"),t))),t}}const dt=Symbol("calculation-value"),mt=Symbol("is-roll-group"),gt=Symbol("modifiers"),yt=Symbol("results"),wt=Symbol("use-in-total");class ResultGroup{constructor(t=[],e=[],r=!1,n=!0){this.isRollGroup=r,this.modifiers=e,this.results=t,this.useInTotal=n}get calculationValue(){return n(this[dt])?parseFloat(this[dt]):this.value}set calculationValue(t){const e=n(t);if(t===1/0)throw new RangeError("Results calculation value must be a finite number");if(t&&!e)throw new TypeError(`Results calculation value is invalid: ${t}`);this[dt]=e?parseFloat(`${t}`):null}get isRollGroup(){return this[mt]}set isRollGroup(t){this[mt]=!!t}get length(){return this.results.length||0}get modifierFlags(){return tt(...this.modifiers)}get modifiers(){return this[gt]}set modifiers(t){if((Array.isArray(t)||t instanceof Set)&&[...t].every((t=>"string"==typeof t)))this[gt]=new Set([...t]);else{if(t||0===t)throw new TypeError(`modifiers must be a Set or array of modifier names: ${t}`);this[gt]=new Set}}get results(){return[...this[yt]]}set results(t){if(!t||!Array.isArray(t))throw new TypeError(`results must be an array: ${t}`);this[yt]=[],t.forEach((t=>{this.addResult(t)}))}get useInTotal(){return!!this[wt]}set useInTotal(t){this[wt]=!!t}get value(){if(!this.results.length)return 0;const t=this.results.reduce(((t,e)=>{let r=e;return e instanceof ResultGroup?r=e.useInTotal?e.calculationValue:0:e instanceof RollResults&&(r=e.value),t+r}),"string"==typeof this.results[0]?"":0);return"string"==typeof t?r(t):t}addResult(t){let e;if(t instanceof ResultGroup||t instanceof RollResults)e=t;else{if("string"!=typeof t&&!n(t))throw new TypeError("value must be one of ResultGroup, RollResults, string, or number");e=t}this[yt].push(e)}toJSON(){const{calculationValue:t,isRollGroup:e,modifierFlags:r,modifiers:n,results:i,useInTotal:o,value:s}=this;return{calculationValue:t,isRollGroup:e,modifierFlags:r,modifiers:[...n],results:i,type:"result-group",useInTotal:o,value:s}}toString(){let t;return t=this.isRollGroup?`{${this.results.join(", ")}}`:this.results.join(""),this.modifierFlags&&(t=`(${t})${this.modifierFlags}`),t}}const bt=Symbol("end"),xt=Symbol("qty");class KeepModifier extends Modifier{constructor(t="h",e=1){super(),this.end=t,this.qty=e,this.order=5}get end(){return this[bt]}set end(t){if("h"!==t&&"l"!==t)throw new RangeError('End must be "h" or "l"');this[bt]=t}get name(){return`keep-${this.end}`}get notation(){return`k${this.end}${this.qty}`}get qty(){return this[xt]}set qty(t){if(t===1/0)throw new RangeError("qty must be a finite number");if(!n(t)||t<1)throw new TypeError("qty must be a positive finite integer");this[xt]=Math.floor(t)}rangeToDrop(t){return"h"===this.end?[0,t.length-this.qty]:[this.qty,t.length]}run(t,e){let r,n;return t instanceof ResultGroup?(r=t.results,n=1===r.length&&r[0]instanceof ResultGroup?r[0].results.map(((t,e)=>t instanceof RollResults?t.rolls.map(((t,r)=>({value:t.value,index:[e,r]}))):null)).flat().filter(Boolean):[...r].map(((t,e)=>({value:t.value,index:e})))):(r=t.rolls,n=[...r].map(((t,e)=>({value:t.value,index:e})))),n=n.sort(((t,e)=>t.value-e.value)).map((t=>t.index)).slice(...this.rangeToDrop(n)),n.forEach((t=>{let e;e=Array.isArray(t)?r[0].results[t[0]].rolls[t[1]]:r[t],e.modifiers.add("drop"),e.useInTotal=!1})),t}toJSON(){const{end:t,qty:e}=this;return Object.assign(super.toJSON(),{end:t,qty:e})}}class DropModifier extends KeepModifier{constructor(t="l",e=1){super(t,e),this.order=6}get name(){return`drop-${this.end}`}get notation(){return`d${this.end}${this.qty}`}rangeToDrop(t){return"h"===this.end?[t.length-this.qty,t.length]:[0,this.qty]}}const vt=Symbol("max");class MaxModifier extends Modifier{constructor(t){super(),this.max=t,this.order=2}get max(){return this[vt]}set max(t){if(!n(t))throw new TypeError("max must be a number");this[vt]=parseFloat(`${t}`)}get name(){return"max"}get notation(){return`max${this.max}`}run(t,e){const r=t;return r.rolls=t.rolls.map((t=>{const e=t;return t.value>this.max&&(e.value=this.max,e.modifiers.add("max")),e})),r}toJSON(){const{max:t}=this;return Object.assign(super.toJSON(),{max:t})}}const Et=Symbol("min");class MinModifier extends Modifier{constructor(t){super(),this.min=t,this.order=1}get min(){return this[Et]}set min(t){if(!n(t))throw new TypeError("min must be a number");this[Et]=parseFloat(`${t}`)}get name(){return"min"}get notation(){return`min${this.min}`}run(t,e){const r=t;return r.rolls=t.rolls.map((t=>{const e=t;return t.value<this.min&&(e.value=this.min,e.modifiers.add("min")),e})),r}toJSON(){const{min:t}=this;return Object.assign(super.toJSON(),{min:t})}}const Rt=Symbol("direction");class SortingModifier extends Modifier{constructor(t="a"){super(),this.direction=t,this.order=10}get direction(){return this[Rt]}set direction(t){if("a"!==t&&"d"!==t)throw new RangeError('Direction must be "a" (Ascending) or "d" (Descending)');this[Rt]=t}get name(){return"sorting"}get notation(){return`s${this.direction}`}run(t,e){let r;return r=t instanceof ResultGroup?"results":"rolls",t[r]=t[r].sort(((t,e)=>"d"===this.direction?e.value-t.value:t.value-e.value)),t instanceof ResultGroup&&(t[r]=t[r].map((t=>t instanceof ResultGroup||t instanceof RollResults?this.run(t,e):t))),t}toJSON(){const{direction:t}=this;return Object.assign(super.toJSON(),{direction:t})}}const St=Symbol("failure-cp");class TargetModifier extends ComparisonModifier{constructor(t,e=null){super(t),this.failureComparePoint=e,this.order=7}get failureComparePoint(){return this[St]}set failureComparePoint(t){if(t&&!(t instanceof ComparePoint))throw new TypeError("failure comparePoint must be instance of ComparePoint or null");this[St]=t||null}get name(){return"target"}get notation(){return`${super.notation}${this.failureComparePoint?`f${this.failureComparePoint}`:""}`}get successComparePoint(){return this.comparePoint}set successComparePoint(t){super.comparePoint=t}getStateValue(t){return this.isSuccess(t)?1:this.isFailure(t)?-1:0}isFailure(t){return!!this.failureComparePoint&&this.failureComparePoint.isMatch(t)}isNeutral(t){return!this.isSuccess(t)&&!this.isFailure(t)}isSuccess(t){return this.isComparePoint(t)}run(t,e){let r;return r=t instanceof ResultGroup?t.results:t.rolls,r.forEach((t=>{this.isSuccess(t.value)?t.modifiers.add("target-success"):this.isFailure(t.value)&&t.modifiers.add("target-failure"),t.calculationValue=this.getStateValue(t.value)})),t}toJSON(){const{failureComparePoint:t,successComparePoint:e}=this,r=super.toJSON();return delete r.comparePoint,Object.assign(r,{failureComparePoint:t,successComparePoint:e})}}var At=Object.freeze({__proto__:null,ComparisonModifier:ComparisonModifier,CriticalFailureModifier:CriticalFailureModifier,CriticalSuccessModifier:CriticalSuccessModifier,DropModifier:DropModifier,ExplodeModifier:ExplodeModifier,KeepModifier:KeepModifier,MaxModifier:MaxModifier,MinModifier:MinModifier,Modifier:Modifier,ReRollModifier:ReRollModifier,SortingModifier:SortingModifier,TargetModifier:TargetModifier}),Mt=Object.freeze({__proto__:null,ResultGroup:ResultGroup,RollResult:RollResult,RollResults:RollResults});const Ct=t=>{try{return!(!t||btoa(atob(t))!==t)}catch(t){return!1}},Tt=t=>{try{const e=!!t&&JSON.parse(t);return!(!e||"object"!=typeof e)}catch(t){return!1}},Ot=Symbol("modifiers"),Nt=Symbol("expressions");class RollGroup{constructor(t=[],e=[]){this.expressions=t,this.modifiers=e}get expressions(){return[...this[Nt]||[]]}set expressions(t){if(!t)throw new RequiredArgumentError("expressions");if(!Array.isArray(t))throw new TypeError(`expressions must be an array: ${t}`);this[Nt]=[],t.forEach((e=>{if(!e||!Array.isArray(e))throw new TypeError(`Expressions must be an array of arrays: ${t}`);if(0===e.length)throw new TypeError(`Sub expressions cannot be empty: ${t}`);if(!e.every((t=>t instanceof StandardDice||"string"==typeof t||"number"==typeof t)))throw new TypeError("Sub expression items must be Dice, numbers, or strings");this[Nt].push(e)}))}get modifiers(){return this[Ot]?new Map([...this[Ot]].sort(((t,e)=>t[1].order-e[1].order))):null}set modifiers(t){let e;if(t instanceof Map)e=t;else if(Array.isArray(t))e=new Map(t.map((t=>[t.name,t])));else{if("object"!=typeof t)throw new TypeError("modifiers should be a Map, array, or an Object containing Modifiers");e=new Map(Object.entries(t))}if(e.size&&[...e.entries()].some((t=>!(t[1]instanceof Modifier))))throw new TypeError("modifiers must only contain Modifier instances");this[Ot]=e}get notation(){let t=this.expressions.map((t=>t.reduce(((t,e)=>t+e),""))).join(", ");return t=`{${t}}`,this.modifiers&&this.modifiers.size&&(t+=[...this.modifiers.values()].reduce(((t,e)=>t+e.notation),"")),t}roll(){const t=new ResultGroup(this.expressions.map((t=>{const e=t.map((t=>t instanceof StandardDice?t.roll():t));return new ResultGroup(e)})));return t.isRollGroup=!0,(this.modifiers||[]).forEach((e=>{e.run(t,this)})),t}toJSON(){const{modifiers:t,notation:e,expressions:r}=this;return{expressions:r,modifiers:t,notation:e,type:"group"}}toString(){return this.notation}}function $t(t,e,r,n){var i=Error.call(this,t);return Object.setPrototypeOf&&Object.setPrototypeOf(i,$t.prototype),i.expected=e,i.found=r,i.location=n,i.name="SyntaxError",i}function Ft(t,e,r){return r=r||" ",t.length>e?t:(e-=t.length,t+(r+=r.repeat(e)).slice(0,e))}function Pt(t,e){var n,i,o,s,a={},u=(e=void 0!==e?e:{}).grammarSource,l={Main:ie},c=ie,h=",",f="d",p="d%",d="dF",m="!",g="max",y="min",w="cs",b="cf",x="!=",v="<=",E=">=",R="<>",S="(",A=")",M="abs",C="ceil",T="cos",O="exp",N="floor",$="log",F="round",P="sign",D="sin",J="sqrt",q="tan",j="pow",I=/^[12]/,G=/^[lh]/,V=/^[.]/,k=/^[1-9]/,_=/^[0-9]/,B=/^[ \t\n\r]/,z=Yt("{",!1),K=Yt(",",!1),W=Yt("}",!1),U=Yt("d",!1),Z=Yt("d%",!1),L=Yt("dF",!1),X=Yt(".",!1),H=te(["1","2"],!1,!1),Q=Yt("!",!1),Y=Yt("p",!1),tt=te(["l","h"],!1,!1),et=Yt("k",!1),rt=Yt("max",!1),nt=Yt("min",!1),it=Yt("r",!1),ot=Yt("o",!1),st=Yt("cs",!1),at=Yt("cf",!1),ut=Yt("s",!1),lt=Yt("a",!1),ct=Yt("f",!1),ht=Yt("!=",!1),ft=Yt("<=",!1),pt=Yt(">=",!1),dt=Yt("=",!1),mt=Yt("<>",!1),gt=Yt(">",!1),yt=Yt("<",!1),wt=Yt("(",!1),bt=Yt(")",!1),xt=Yt("abs",!1),vt=Yt("ceil",!1),Et=Yt("cos",!1),Rt=Yt("exp",!1),St=Yt("floor",!1),At=Yt("log",!1),Mt=Yt("round",!1),Ct=Yt("sign",!1),Tt=Yt("sin",!1),Ot=Yt("sqrt",!1),Nt=Yt("tan",!1),Ft=Yt("pow",!1),Pt=Yt("-",!1),Dt=te(["."],!1,!1),Jt=te([["1","9"]],!1,!1),qt=te([["0","9"]],!1,!1),jt=Yt("**",!1),It=Yt("*",!1),Gt=Yt("^",!1),Vt=Yt("%",!1),kt=Yt("/",!1),_t=Yt("+",!1),Bt={type:"other",description:"whitespace"},zt=te([" ","\t","\n","\r"],!1,!1),Kt=function(){return parseInt(Qt(),10)},Wt=0,Ut=0,Zt=[{line:1,column:1}],Lt=0,Xt=[],Ht=0;if("startRule"in e){if(!(e.startRule in l))throw new Error("Can't start parsing from rule \""+e.startRule+'".');c=l[e.startRule]}function Qt(){return t.substring(Ut,Wt)}function Yt(t,e){return{type:"literal",text:t,ignoreCase:e}}function te(t,e,r){return{type:"class",parts:t,inverted:e,ignoreCase:r}}function ee(e){var r,n=Zt[e];if(n)return n;for(r=e-1;!Zt[r];)r--;for(n={line:(n=Zt[r]).line,column:n.column};r<e;)10===t.charCodeAt(r)?(n.line++,n.column=1):n.column++,r++;return Zt[e]=n,n}function re(t,e){var r=ee(t),n=ee(e);return{source:u,start:{offset:t,line:r.line,column:r.column},end:{offset:e,line:n.line,column:n.column}}}function ne(t){Wt<Lt||(Wt>Lt&&(Lt=Wt,Xt=[]),Xt.push(t))}function ie(){return ce()}function oe(){var e,r,n,i,o,s,u,l,c,h;if(e=Wt,123===t.charCodeAt(Wt)?(r="{",Wt++):(r=a,0===Ht&&ne(z)),r!==a)if(ge(),(n=ce())!==a){for(i=[],o=Wt,s=ge(),44===t.charCodeAt(Wt)?(u=",",Wt++):(u=a,0===Ht&&ne(K)),u!==a?(l=ge(),(c=ce())!==a?o=s=[s,u,l,c]:(Wt=o,o=a)):(Wt=o,o=a);o!==a;)i.push(o),o=Wt,s=ge(),44===t.charCodeAt(Wt)?(u=",",Wt++):(u=a,0===Ht&&ne(K)),u!==a?(l=ge(),(c=ce())!==a?o=s=[s,u,l,c]:(Wt=o,o=a)):(Wt=o,o=a);if(o=ge(),125===t.charCodeAt(Wt)?(s="}",Wt++):(s=a,0===Ht&&ne(W)),s!==a){for(u=[],l=ae();l!==a;)u.push(l),l=ae();Ut=e,h=u,e=new RollGroup([n,...i.map((t=>t[3]))],Object.assign({},...h.map((t=>({[t.name]:t})))))}else Wt=e,e=a}else Wt=e,e=a;else Wt=e,e=a;return e}function se(){var e,r,n,i;if(e=Wt,r=function(){var e,r,n,i;e=Wt,(r=le())===a&&(r=null);100===t.charCodeAt(Wt)?(n=f,Wt++):(n=a,0===Ht&&ne(U));n!==a&&(i=le())!==a?(Ut=e,e=new StandardDice(i,r||1)):(Wt=e,e=a);return e}(),r===a&&(r=function(){var e,r,n;e=Wt,(r=le())===a&&(r=null);t.substr(Wt,2)===p?(n=p,Wt+=2):(n=a,0===Ht&&ne(Z));n!==a?(Ut=e,e=new PercentileDice(r||1)):(Wt=e,e=a);return e}(),r===a&&(r=function(){var e,r,n,i,o,s;e=Wt,(r=le())===a&&(r=null);t.substr(Wt,2)===d?(n=d,Wt+=2):(n=a,0===Ht&&ne(L));n!==a?(i=Wt,46===t.charCodeAt(Wt)?(o=".",Wt++):(o=a,0===Ht&&ne(X)),o!==a?(I.test(t.charAt(Wt))?(s=t.charAt(Wt),Wt++):(s=a,0===Ht&&ne(H)),s!==a?i=o=[o,s]:(Wt=i,i=a)):(Wt=i,i=a),i===a&&(i=null),Ut=e,u=r,e=new FudgeDice((l=i)?parseInt(l[1],10):2,u||1)):(Wt=e,e=a);var u,l;return e}())),r!==a){for(n=[],i=ae();i!==a;)n.push(i),i=ae();Ut=e,e=function(t,e){return t.modifiers=Object.assign({},...e.map((t=>({[t.name]:t})))),t}(r,n)}else Wt=e,e=a;return e}function ae(){var e;return(e=function(){var e,r,n,i,o;e=Wt,33===t.charCodeAt(Wt)?(r=m,Wt++):(r=a,0===Ht&&ne(Q));r!==a?(33===t.charCodeAt(Wt)?(n=m,Wt++):(n=a,0===Ht&&ne(Q)),n===a&&(n=null),112===t.charCodeAt(Wt)?(i="p",Wt++):(i=a,0===Ht&&ne(Y)),i===a&&(i=null),(o=ue())===a&&(o=null),Ut=e,e=new ExplodeModifier(o,!!n,!!i)):(Wt=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=Wt,(r=ue())!==a?(n=function(){var e,r,n;e=Wt,102===t.charCodeAt(Wt)?(r="f",Wt++):(r=a,0===Ht&&ne(ct));r!==a&&(n=ue())!==a?(Ut=e,e=n):(Wt=e,e=a);return e}(),n===a&&(n=null),Ut=e,e=new TargetModifier(r,n)):(Wt=e,e=a);return e}())===a&&(e=function(){var e,r,n,i;e=Wt,100===t.charCodeAt(Wt)?(r=f,Wt++):(r=a,0===Ht&&ne(U));r!==a?(G.test(t.charAt(Wt))?(n=t.charAt(Wt),Wt++):(n=a,0===Ht&&ne(tt)),n===a&&(n=null),(i=pe())!==a?(Ut=e,e=new DropModifier(n||"l",i)):(Wt=e,e=a)):(Wt=e,e=a);return e}())===a&&(e=function(){var e,r,n,i;e=Wt,107===t.charCodeAt(Wt)?(r="k",Wt++):(r=a,0===Ht&&ne(et));r!==a?(G.test(t.charAt(Wt))?(n=t.charAt(Wt),Wt++):(n=a,0===Ht&&ne(tt)),n===a&&(n=null),(i=pe())!==a?(Ut=e,e=new KeepModifier(n||"h",i)):(Wt=e,e=a)):(Wt=e,e=a);return e}())===a&&(e=function(){var e,r,n,i;e=Wt,114===t.charCodeAt(Wt)?(r="r",Wt++):(r=a,0===Ht&&ne(it));r!==a?(111===t.charCodeAt(Wt)?(n="o",Wt++):(n=a,0===Ht&&ne(ot)),n===a&&(n=null),(i=ue())===a&&(i=null),Ut=e,e=new ReRollModifier(!!n,i)):(Wt=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=Wt,t.substr(Wt,2)===w?(r=w,Wt+=2):(r=a,0===Ht&&ne(st));r!==a&&(n=ue())!==a?(Ut=e,e=new CriticalSuccessModifier(n)):(Wt=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=Wt,t.substr(Wt,2)===b?(r=b,Wt+=2):(r=a,0===Ht&&ne(at));r!==a&&(n=ue())!==a?(Ut=e,e=new CriticalFailureModifier(n)):(Wt=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=Wt,115===t.charCodeAt(Wt)?(r="s",Wt++):(r=a,0===Ht&&ne(ut));r!==a?(97===t.charCodeAt(Wt)?(n="a",Wt++):(n=a,0===Ht&&ne(lt)),n===a&&(100===t.charCodeAt(Wt)?(n=f,Wt++):(n=a,0===Ht&&ne(U))),n===a&&(n=null),Ut=e,e=new SortingModifier(n||"a")):(Wt=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=Wt,t.substr(Wt,3)===g?(r=g,Wt+=3):(r=a,0===Ht&&ne(rt));r!==a&&(n=fe())!==a?(Ut=e,e=new MaxModifier(n)):(Wt=e,e=a);return e}())===a&&(e=function(){var e,r,n;e=Wt,t.substr(Wt,3)===y?(r=y,Wt+=3):(r=a,0===Ht&&ne(nt));r!==a&&(n=fe())!==a?(Ut=e,e=new MinModifier(n)):(Wt=e,e=a);return e}()),e}function ue(){var e,r,n;return e=Wt,r=function(){var e;t.substr(Wt,2)===x?(e=x,Wt+=2):(e=a,0===Ht&&ne(ht));e===a&&(t.substr(Wt,2)===v?(e=v,Wt+=2):(e=a,0===Ht&&ne(ft)),e===a&&(t.substr(Wt,2)===E?(e=E,Wt+=2):(e=a,0===Ht&&ne(pt)),e===a&&(61===t.charCodeAt(Wt)?(e="=",Wt++):(e=a,0===Ht&&ne(dt)),e===a&&(t.substr(Wt,2)===R?(e=R,Wt+=2):(e=a,0===Ht&&ne(mt)),e===a&&(62===t.charCodeAt(Wt)?(e=">",Wt++):(e=a,0===Ht&&ne(gt)),e===a&&(60===t.charCodeAt(Wt)?(e="<",Wt++):(e=a,0===Ht&&ne(yt))))))));return e}(),r!==a&&(n=fe())!==a?(Ut=e,e=new ComparePoint(r,n)):(Wt=e,e=a),e}function le(){var e,n,i,o,s,u,l,c,h,f;if((e=pe())===a)if(e=Wt,40===t.charCodeAt(Wt)?(n=S,Wt++):(n=a,0===Ht&&ne(wt)),n!==a){if(ge(),i=Wt,(o=fe())!==a){if(s=[],u=Wt,l=ge(),(c=me())!==a?(h=ge(),(f=fe())!==a?u=l=[l,c,h,f]:(Wt=u,u=a)):(Wt=u,u=a),u!==a)for(;u!==a;)s.push(u),u=Wt,l=ge(),(c=me())!==a?(h=ge(),(f=fe())!==a?u=l=[l,c,h,f]:(Wt=u,u=a)):(Wt=u,u=a);else s=a;s!==a?i=o=[o,s]:(Wt=i,i=a)}else Wt=i,i=a;i!==a?(o=ge(),41===t.charCodeAt(Wt)?(s=A,Wt++):(s=a,0===Ht&&ne(bt)),s!==a?(Ut=e,e=r(Qt())):(Wt=e,e=a)):(Wt=e,e=a)}else Wt=e,e=a;return e}function ce(){var t,e,r,n,i,o,s,u,l,c;if(t=Wt,(e=he())!==a){for(r=[],n=Wt,i=ge(),(o=me())!==a?(s=ge(),(u=he())!==a?n=i=[i,o,s,u]:(Wt=n,n=a)):(Wt=n,n=a);n!==a;)r.push(n),n=Wt,i=ge(),(o=me())!==a?(s=ge(),(u=he())!==a?n=i=[i,o,s,u]:(Wt=n,n=a)):(Wt=n,n=a);Ut=t,l=e,c=r,l=Array.isArray(l)?l:[l],t=[...l,...c.map((([,t,,e])=>[t,e])).flat(2)]}else Wt=t,t=a;return t}function he(){var e,r,n,i,o,s;return e=function(){var e,r,n,i,o,s,u;e=Wt,t.substr(Wt,3)===M?(r=M,Wt+=3):(r=a,0===Ht&&ne(xt));r===a&&(t.substr(Wt,4)===C?(r=C,Wt+=4):(r=a,0===Ht&&ne(vt)),r===a&&(t.substr(Wt,3)===T?(r=T,Wt+=3):(r=a,0===Ht&&ne(Et)),r===a&&(t.substr(Wt,3)===O?(r=O,Wt+=3):(r=a,0===Ht&&ne(Rt)),r===a&&(t.substr(Wt,5)===N?(r=N,Wt+=5):(r=a,0===Ht&&ne(St)),r===a&&(t.substr(Wt,3)===$?(r=$,Wt+=3):(r=a,0===Ht&&ne(At)),r===a&&(t.substr(Wt,5)===F?(r=F,Wt+=5):(r=a,0===Ht&&ne(Mt)),r===a&&(t.substr(Wt,4)===P?(r=P,Wt+=4):(r=a,0===Ht&&ne(Ct)),r===a&&(t.substr(Wt,3)===D?(r=D,Wt+=3):(r=a,0===Ht&&ne(Tt)),r===a&&(t.substr(Wt,4)===J?(r=J,Wt+=4):(r=a,0===Ht&&ne(Ot)),r===a&&(t.substr(Wt,3)===q?(r=q,Wt+=3):(r=a,0===Ht&&ne(Nt))))))))))));r!==a?(40===t.charCodeAt(Wt)?(n=S,Wt++):(n=a,0===Ht&&ne(wt)),n!==a?(ge(),(i=ce())!==a?(ge(),41===t.charCodeAt(Wt)?(o=A,Wt++):(o=a,0===Ht&&ne(bt)),o!==a?(Ut=e,l=i,e=[`${r}(`,...l,")"]):(Wt=e,e=a)):(Wt=e,e=a)):(Wt=e,e=a)):(Wt=e,e=a);var l;e===a&&(e=Wt,t.substr(Wt,3)===j?(r=j,Wt+=3):(r=a,0===Ht&&ne(Ft)),r===a&&(t.substr(Wt,3)===g?(r=g,Wt+=3):(r=a,0===Ht&&ne(rt)),r===a&&(t.substr(Wt,3)===y?(r=y,Wt+=3):(r=a,0===Ht&&ne(nt)))),r!==a?(40===t.charCodeAt(Wt)?(n=S,Wt++):(n=a,0===Ht&&ne(wt)),n!==a?(ge(),(i=ce())!==a?(ge(),44===t.charCodeAt(Wt)?(o=h,Wt++):(o=a,0===Ht&&ne(K)),o!==a?(ge(),(s=ce())!==a?(ge(),41===t.charCodeAt(Wt)?(u=A,Wt++):(u=a,0===Ht&&ne(bt)),u!==a?(Ut=e,e=function(t,e,r){return[`${t}(`,...e,",",...r,")"]}(r,i,s)):(Wt=e,e=a)):(Wt=e,e=a)):(Wt=e,e=a)):(Wt=e,e=a)):(Wt=e,e=a)):(Wt=e,e=a));return e}(),e===a&&(e=se())===a&&(e=fe())===a&&(e=Wt,40===t.charCodeAt(Wt)?(r=S,Wt++):(r=a,0===Ht&&ne(wt)),r!==a?(ge(),(n=ce())!==a?(ge(),41===t.charCodeAt(Wt)?(i=A,Wt++):(i=a,0===Ht&&ne(bt)),i!==a?(Ut=e,o=n,s=i,e=[r,...o,s]):(Wt=e,e=a)):(Wt=e,e=a)):(Wt=e,e=a),e===a&&(e=oe())),e}function fe(){var e,r,n,i;return e=Wt,45===t.charCodeAt(Wt)?Wt++:0===Ht&&ne(Pt),de()!==a?(r=Wt,V.test(t.charAt(Wt))?(n=t.charAt(Wt),Wt++):(n=a,0===Ht&&ne(Dt)),n!==a&&(i=de())!==a?r=n=[n,i]:(Wt=r,r=a),r===a&&(r=null),Ut=e,e=parseFloat(Qt())):(Wt=e,e=a),e}function pe(){var e,r,n,i;if(e=Wt,k.test(t.charAt(Wt))?(r=t.charAt(Wt),Wt++):(r=a,0===Ht&&ne(Jt)),r!==a){for(n=[],_.test(t.charAt(Wt))?(i=t.charAt(Wt),Wt++):(i=a,0===Ht&&ne(qt));i!==a;)n.push(i),_.test(t.charAt(Wt))?(i=t.charAt(Wt),Wt++):(i=a,0===Ht&&ne(qt));Ut=e,e=Kt()}else Wt=e,e=a;return e}function de(){var e,r,n;if(e=Wt,r=[],_.test(t.charAt(Wt))?(n=t.charAt(Wt),Wt++):(n=a,0===Ht&&ne(qt)),n!==a)for(;n!==a;)r.push(n),_.test(t.charAt(Wt))?(n=t.charAt(Wt),Wt++):(n=a,0===Ht&&ne(qt));else r=a;return r!==a&&(Ut=e,r=Kt()),e=r}function me(){var e,r;return e=Wt,"**"===t.substr(Wt,2)?(r="**",Wt+=2):(r=a,0===Ht&&ne(jt)),r!==a&&(Ut=e,r="^"),(e=r)===a&&(42===t.charCodeAt(Wt)?(e="*",Wt++):(e=a,0===Ht&&ne(It)),e===a&&(94===t.charCodeAt(Wt)?(e="^",Wt++):(e=a,0===Ht&&ne(Gt)),e===a&&(37===t.charCodeAt(Wt)?(e="%",Wt++):(e=a,0===Ht&&ne(Vt)),e===a&&(47===t.charCodeAt(Wt)?(e="/",Wt++):(e=a,0===Ht&&ne(kt)),e===a&&(43===t.charCodeAt(Wt)?(e="+",Wt++):(e=a,0===Ht&&ne(_t)),e===a&&(45===t.charCodeAt(Wt)?(e="-",Wt++):(e=a,0===Ht&&ne(Pt)))))))),e}function ge(){var e,r;for(Ht++,e=[],B.test(t.charAt(Wt))?(r=t.charAt(Wt),Wt++):(r=a,0===Ht&&ne(zt));r!==a;)e.push(r),B.test(t.charAt(Wt))?(r=t.charAt(Wt),Wt++):(r=a,0===Ht&&ne(zt));return Ht--,r=a,0===Ht&&ne(Bt),e}if((n=c())!==a&&Wt===t.length)return n;throw n!==a&&Wt<t.length&&ne({type:"end"}),i=Xt,o=Lt<t.length?t.charAt(Lt):null,s=Lt<t.length?re(Lt,Lt+1):re(Lt,Lt),new $t($t.buildMessage(i,o),i,o,s)}!function(t,e){function r(){this.constructor=t}r.prototype=e.prototype,t.prototype=new r}($t,Error),$t.prototype.format=function(t){var e="Error: "+this.message;if(this.location){var r,n=null;for(r=0;r<t.length;r++)if(t[r].source===this.location.source){n=t[r].text.split(/\r\n|\n|\r/g);break}var i=this.location.start,o=this.location.source+":"+i.line+":"+i.column;if(n){var s=this.location.end,a=Ft("",i.line.toString().length),u=n[i.line-1],l=i.line===s.line?s.column:u.length+1;e+="\n --\x3e "+o+"\n"+a+" |\n"+i.line+" | "+u+"\n"+a+" | "+Ft("",i.column-1)+Ft("",l-i.column,"^")}else e+="\n at "+o}return e},$t.buildMessage=function(t,e){var r={literal:function(t){return'"'+i(t.text)+'"'},class:function(t){var e=t.parts.map((function(t){return Array.isArray(t)?o(t[0])+"-"+o(t[1]):o(t)}));return"["+(t.inverted?"^":"")+e+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(t){return t.description}};function n(t){return t.charCodeAt(0).toString(16).toUpperCase()}function i(t){return t.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(t){return"\\x0"+n(t)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(t){return"\\x"+n(t)}))}function o(t){return t.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,(function(t){return"\\x0"+n(t)})).replace(/[\x10-\x1F\x7F-\x9F]/g,(function(t){return"\\x"+n(t)}))}function s(t){return r[t.type](t)}return"Expected "+function(t){var e,r,n=t.map(s);if(n.sort(),n.length>0){for(e=1,r=1;e<n.length;e++)n[e-1]!==n[e]&&(n[r]=n[e],r++);n.length=r}switch(n.length){case 1:return n[0];case 2:return n[0]+" or "+n[1];default:return n.slice(0,-1).join(", ")+", or "+n[n.length-1]}}(t)+" but "+function(t){return t?'"'+i(t)+'"':"end of input"}(e)+" found."};class Parser{static parse(t){if(!t)throw new RequiredArgumentError("notation");if("string"!=typeof t)throw new TypeError("Notation must be a string");return Pt(t)}}const Dt=Object.freeze({BASE_64:1,JSON:0,OBJECT:2}),Jt=Symbol("notation"),qt=Symbol("maxTotal"),jt=Symbol("minTotal"),It=Symbol("expressions"),Gt=Symbol("roll-method"),Vt=Symbol("rolls"),kt=Symbol("set-rolls"),_t=Symbol("total"),Bt=t=>((t,e=0)=>parseFloat(parseFloat(`${t}`).toFixed(e||0)))(t.calculationValue,2);class DiceRoll{constructor(t){if(!t)throw new RequiredArgumentError("notation");if(this[It]=[],t instanceof Object&&!Array.isArray(t)){if(!t.notation)throw new RequiredArgumentError("notation");if("string"!=typeof t.notation)throw new NotationError(t.notation);t.rolls&&this[kt](t.rolls),this[Jt]=t.notation,this[It]=Parser.parse(this.notation),this.hasRolls()||this.roll()}else{if("string"!=typeof t)throw new NotationError(t);this[Jt]=t,this[It]=Parser.parse(this.notation),this.roll()}}get averageTotal(){return(this.maxTotal+this.minTotal)/2}get maxTotal(){if(!this.hasExpressions())return 0;if(!this[qt]){const t=this[Gt](K.max);this[qt]=Bt(t)}return this[qt]}get minTotal(){if(!this.hasExpressions())return 0;if(!this[jt]){const t=this[Gt](K.min);this[jt]=Bt(t)}return this[jt]}get notation(){return this[Jt]}get output(){let t=`${this.notation}: `;return this.hasRolls()?t+=`${this[Vt]} = ${this.total}`:t+="No dice rolled",t}get rolls(){return this[Vt]?this[Vt].results:[]}get total(){return!this[_t]&&this.hasRolls()&&(this[_t]=Bt(this[Vt])),this[_t]||0}export(t=Dt.JSON){switch(t){case Dt.BASE_64:return btoa(this.export(Dt.JSON));case Dt.JSON:return JSON.stringify(this);case Dt.OBJECT:return JSON.parse(this.export(Dt.JSON));default:throw new TypeError(`Invalid export format "${t}"`)}}hasExpressions(){return this[It]&&this[It].length>0}hasRolls(){return this.hasExpressions()&&this.rolls.length>0}roll(){return this[_t]=0,this[Vt]=this[Gt](),this.rolls}toJSON(){const{averageTotal:t,maxTotal:e,minTotal:r,notation:n,output:i,rolls:o,total:s}=this;return{averageTotal:t,maxTotal:e,minTotal:r,notation:n,output:i,rolls:o,total:s,type:"dice-roll"}}toString(){return this.output}static import(t){if(t){if(Tt(t))return DiceRoll.import(JSON.parse(t));if(Ct(t))return DiceRoll.import(atob(t));if("object"==typeof t)return new DiceRoll(t);throw new DataFormatError(t)}throw new RequiredArgumentError("data")}[Gt](t){let e;t&&(e=W.engine,W.engine=t);const r=new ResultGroup(this[It].map((t=>t instanceof StandardDice||t instanceof RollGroup?t.roll():t)).filter((t=>!!t||0===t)));return t&&(W.engine=e),r}[kt](t){if(t instanceof ResultGroup)this[Vt]=t;else if(t instanceof RollResults)this[Vt]=new ResultGroup([t]);else{if(!Array.isArray(t))throw new TypeError("Rolls must be a valid result object, or an array");this[Vt]=new ResultGroup(t.map((t=>{if(t instanceof ResultGroup||t instanceof RollResults)return t;if(Array.isArray(t))return new RollResults(t);if("object"==typeof t){if(Array.isArray(t.results))return new ResultGroup(t.results,t.modifiers||[],t.isRollGroup||!1,"boolean"!=typeof t.useInTotal||t.useInTotal);if(Array.isArray(t.rolls))return new RollResults(t.rolls)}return t})))}}}const zt=Symbol("log");class DiceRoller{constructor(t){this[zt]=[],t&&this.import(t)}get log(){return this[zt]||[]}get output(){return this.log.join("; ")}get total(){return this.log.reduce(((t,e)=>t+e.total),0)}clearLog(){this[zt].length=0}export(t=Dt.JSON){switch(t){case Dt.BASE_64:return btoa(this.export(Dt.JSON));case Dt.JSON:return JSON.stringify(this);case Dt.OBJECT:return JSON.parse(this.export(Dt.JSON));default:throw new TypeError(`Invalid export format "${t}"`)}}import(t){if(t){if(Tt(t))return this.import(JSON.parse(t));if(Ct(t))return this.import(atob(t));if("object"==typeof t){let e=t.log||null;if(!t.log&&Array.isArray(t)&&t.length&&(e=t),e&&Array.isArray(e))e.forEach((t=>{this[zt].push(DiceRoll.import(t))}));else if(e)throw new TypeError("log must be an array");return this.log}throw new DataFormatError(t)}throw new RequiredArgumentError("data")}roll(...t){const e=t.filter(Boolean);if(0===e.length)throw new RequiredArgumentError("notations");const r=e.map((t=>{const e=new DiceRoll(t);return this[zt].push(e),e}));return r.length>1?r:r[0]}toJSON(){const{log:t,output:e,total:r}=this;return{log:t,output:e,total:r,type:"dice-roller"}}toString(){return this.output}static import(t){const e=new DiceRoller;return e.import(t),e}}export{ComparePoint,pt as Dice,DiceRoll,DiceRoller,e as Exceptions,At as Modifiers,U as NumberGenerator,Parser,Mt as Results,RollGroup,Dt as exportFormats};
